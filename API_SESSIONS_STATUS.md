# API Документация: Сессии и Статусы Пользователей

## Обзор

Добавлены новые функции для управления сессиями пользователей и отслеживания их статусов в реальном времени.

## Новые модели данных

### UserSession
- `id` - ID сессии
- `user_id` - ID пользователя
- `session_token` - JTI токена
- `device_type` - Тип устройства (pc, phone, tablet, web)
- `device_name` - Название устройства
- `ip_address` - IP адрес
- `user_agent` - User-Agent браузера/приложения
- `created_at` - Время создания сессии
- `last_activity` - Последняя активность
- `is_active` - Активна ли сессия

### UserStatus
- `user_id` - ID пользователя
- `status` - Статус (online, offline, away)
- `last_seen` - Время последнего появления
- `is_typing_in_chat` - ID чата где печатает (null если не печатает)
- `typing_started_at` - Время начала печатания
- `updated_at` - Время обновления статуса

### MessageReadStatus
- `user_id` - ID пользователя
- `chat_id` - ID чата
- `last_read_message_id` - UUID последнего прочитанного сообщения
- `read_at` - Время прочтения
- `updated_at` - Время обновления

## API Endpoints

### Управление сессиями

#### GET /sessions/
Получить список всех активных сессий пользователя.

**Ответ:**
```json
{
  "sessions": [
    {
      "id": 1,
      "device_type": "phone",
      "device_name": "Android App",
      "ip_address": "192.168.1.100",
      "created_at": "2024-01-01T12:00:00Z",
      "last_activity": "2024-01-01T12:30:00Z",
      "is_current": true
    }
  ]
}
```

#### DELETE /sessions/{session_id}
Удалить конкретную сессию.

**Ответ:**
```json
{
  "status": "ok",
  "message": "Сессия успешно удалена"
}
```

#### POST /sessions/revoke_all
Удалить все сессии кроме текущей.

**Ответ:**
```json
{
  "status": "ok",
  "revoked_count": 3
}
```

### Управление статусами

#### GET /status/me
Получить свой статус.

**Ответ:**
```json
{
  "user_id": 12345,
  "status": "online",
  "last_seen": "2024-01-01T12:30:00Z",
  "is_typing_in_chat": null
}
```

#### POST /status/typing
Установить статус печатания в чате.

**Запрос:**
```json
{
  "chat_id": 123
}
```

Для остановки печатания:
```json
{
  "chat_id": null
}
```

#### POST /status/read
Отметить сообщения как прочитанные.

**Запрос:**
```json
{
  "chat_id": 123,
  "message_id": "uuid-message-id"
}
```

#### GET /status/contacts
Получить статусы всех контактов.

**Ответ:**
```json
{
  "contacts": [
    {
      "user_id": 67890,
      "status": "online",
      "last_seen": "2024-01-01T12:25:00Z",
      "is_typing_in_chat": 123
    }
  ]
}
```

#### POST /status/online
Установить статус онлайн.

#### POST /status/offline
Установить статус оффлайн.

## WebSocket События

### Изменение статуса контакта
```json
{
  "type": "status_change",
  "user_id": 67890,
  "status": "online",
  "timestamp": "2024-01-01T12:30:00Z"
}
```

### Начало печатания
```json
{
  "type": "typing_start",
  "user_id": 67890,
  "chat_id": 123,
  "timestamp": "2024-01-01T12:30:00Z"
}
```

### Остановка печатания
```json
{
  "type": "typing_stop",
  "user_id": 67890,
  "timestamp": "2024-01-01T12:30:00Z"
}
```

### Прочтение сообщений
```json
{
  "type": "messages_read",
  "user_id": 67890,
  "chat_id": 123,
  "last_read_message_id": "uuid-message-id",
  "timestamp": "2024-01-01T12:30:00Z"
}
```

## Автоматическое управление статусами

### При подключении WebSocket
- Пользователь автоматически переводится в статус "online"
- Контакты получают уведомление о появлении в сети

### При отключении WebSocket
- Пользователь автоматически переводится в статус "offline"
- Сбрасывается статус печатания
- Контакты получают уведомление об уходе из сети

### При активности
- Время последней активности обновляется при каждом WebSocket сообщении
- Если пользователь был оффлайн, автоматически переводится в онлайн

## Интеграция с клиентом

### При логине
- Автоматически создается запись сессии с информацией об устройстве
- Определяется тип устройства по User-Agent
- Сохраняется IP адрес и информация о браузере/приложении

### Рекомендации для клиента

1. **Отслеживание статусов контактов:**
   - Подписаться на WebSocket события `status_change`
   - Периодически запрашивать `/status/contacts` для синхронизации

2. **Индикатор печатания:**
   - Отправлять `POST /status/typing` при начале ввода
   - Отправлять с `chat_id: null` при остановке ввода
   - Показывать индикатор при получении `typing_start`

3. **Статусы прочтения:**
   - Отправлять `POST /status/read` при просмотре сообщений
   - Обновлять UI при получении `messages_read`

4. **Управление сессиями:**
   - Показывать список активных устройств из `/sessions/`
   - Позволить пользователю удалять сессии
   - Показывать текущую сессию отдельно

## Безопасность

- Все endpoints требуют авторизации
- Пользователь может управлять только своими сессиями
- WebSocket события отправляются только контактам (взаимные подписки)
- Статусы печатания видны только участникам чата
