# WebSocket Fix Changelog

## –î–∞—Ç–∞: 2025-10-20

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

#### 1. Origin Blocking - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ

**–§–∞–π–ª:** `app/ws.py` (—Å—Ç—Ä–æ–∫–∏ 105-129)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–°–µ—Ä–≤–µ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—Å–µ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Ç Flutter –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏–∑-–∑–∞ —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ Origin. Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π web origin, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –∑–∞–∫—Ä—ã—Ç–∏—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∫–æ–¥–æ–º 1008.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ User-Agent –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- –†–∞–∑—Ä–µ—à–µ–Ω—ã –ø—É—Å—Ç—ã–µ –∏ null origins –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ origin –∏ User-Agent
- –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å 'Dart' –∏–ª–∏ 'Flutter' –≤ User-Agent) —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ allowed origins –¥–ª—è Flutter –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
allowed_origins = [
    'https://pixeltoo.ru', 
    'https://mlo.pixeltoo.ru', 
    'file://', 
    'null',
    '',  # –ü—É—Å—Ç–æ–π origin –æ—Ç –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
]

# –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π origin –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ null
is_mobile_app = 'Dart' in user_agent or 'Flutter' in user_agent or origin in ['', 'null']

if not is_mobile_app and origin not in allowed_origins:
    logger.warning(f"‚ùå [WS] –ù–µ–≤–µ—Ä–Ω—ã–π origin: {origin}, User-Agent: {user_agent}, IP={remote_addr}")
    await websocket.close(code=1008, reason="–ù–µ–≤–µ—Ä–Ω—ã–π origin")
    return

logger.debug(f"‚úÖ [WS] Origin accepted: {origin}, User-Agent: {user_agent}")
```

---

#### 2. Android Network Security Config - –î–û–ë–ê–í–õ–ï–ù–û ‚úÖ

**–§–∞–π–ª—ã:**
- `flutter/mvp/android/app/src/main/res/xml/network_security_config.xml` (–ù–û–í–´–ô)
- `flutter/mvp/android/app/src/main/AndroidManifest.xml` (–û–ë–ù–û–í–õ–ï–ù)

**–ü—Ä–æ–±–ª–µ–º–∞:**
Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–º–µ–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å HTTPS/WSS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω `network_security_config.xml` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–æ–≤–µ—Ä–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º
- –û–±–Ω–æ–≤–ª–µ–Ω `AndroidManifest.xml`:
  - –î–æ–±–∞–≤–ª–µ–Ω–æ `android:usesCleartextTraffic="false"` (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
  - –î–æ–±–∞–≤–ª–µ–Ω–æ `android:networkSecurityConfig="@xml/network_security_config"`
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –¥–æ–≤–µ—Ä–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º
- –î–æ–±–∞–≤–ª–µ–Ω—ã debug-overrides –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ network_security_config.xml:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <!-- Allow all secure connections (HTTPS/WSS) -->
    <base-config cleartextTrafficPermitted="false">
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </base-config>
    
    <domain-config cleartextTrafficPermitted="false">
        <domain includeSubdomains="true">pixeltoo.ru</domain>
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </domain-config>
    
    <debug-overrides>
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </debug-overrides>
</network-security-config>
```

---

### ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

#### 3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket - –£–õ–£–ß–®–ï–ù–û ‚úÖ

**–§–∞–π–ª:** `flutter/mvp/lib/data/data_sources/remote/websocket_client.dart`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—Ç—Ä—É–¥–Ω—è–ª–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º WebSocket.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã —ç–º–æ–¥–∑–∏-–ø—Ä–µ—Ñ–∏–∫—Å—ã (üîå, ‚úÖ, ‚ùå, ‚ö†Ô∏è) –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –ª–æ–≥–∞—Ö
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
  - –ù–∞—á–∞–ª–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  - –°–æ–∑–¥–∞–Ω–∏–µ URI
  - –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞–Ω–∞–ª–∞
  - –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  - –ó–∞–ø—É—Å–∫ ping —Ç–∞–π–º–µ—Ä–∞
- –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:
  - `SocketException` - –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é/—Å–µ—Ä–≤–µ—Ä–æ–º
  - `TimeoutException` - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è
  - `FormatException` - –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL/—Ç–æ–∫–µ–Ω–∞
  - `HandshakeException` - –ø—Ä–æ–±–ª–µ–º—ã SSL/TLS
  - `WebSocketChannelException` - –æ—à–∏–±–∫–∏ WebSocket –∫–∞–Ω–∞–ª–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏–Ω—ã —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–∞—Ö –æ—à–∏–±–æ–∫

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**
```
üîå [WS] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket: wss://pixeltoo.ru:8089
üîå [WS] URI: wss://pixeltoo.ru:8089?token=...
üîå [WS] Token length: 1024
üîå [WS] –°–æ–∑–¥–∞–Ω–∏–µ WebSocket –∫–∞–Ω–∞–ª–∞...
üîå [WS] –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞–Ω–∞–ª–∞ (timeout 10s)...
‚úÖ [WS] WebSocket —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!
‚úÖ [WS] Ping —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω
```

---

#### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –î–û–ë–ê–í–õ–ï–ù–û ‚úÖ

**–§–∞–π–ª:** `flutter/mvp/lib/data/data_sources/remote/websocket_client.dart`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**–î–æ:**
```dart
catch (e, stack) {
  _isConnecting = false;
  _updateStatus(WebSocketStatus.error);
  AppLogger.e('WebSocket connection failed', 'WS', e, stack);
  _scheduleReconnect();
}
```

**–ü–æ—Å–ª–µ:**
```dart
} on SocketException catch (e, stack) {
  AppLogger.e('‚ùå [WS] SocketException: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'WS', e, stack);
  AppLogger.e('‚ùå [WS] –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ–≤–µ—Ä–Ω—ã–π URL', 'WS');
  _scheduleReconnect();
} on TimeoutException catch (e, stack) {
  AppLogger.e('‚ùå [WS] TimeoutException: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'WS', e, stack);
  _scheduleReconnect();
} on HandshakeException catch (e, stack) {
  AppLogger.e('‚ùå [WS] HandshakeException: –û—à–∏–±–∫–∞ SSL/TLS handshake', 'WS', e, stack);
  AppLogger.e('‚ùå [WS] –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –ø—Ä–æ–±–ª–µ–º–∞ —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–∞', 'WS');
  _scheduleReconnect();
}
// ... –∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ _onError:**
```dart
void _onError(dynamic error) {
  AppLogger.e('‚ùå [WS] WebSocket stream error', 'WS', error);
  if (error is SocketException) {
    AppLogger.e('‚ùå [WS] SocketException –≤ stream: ${error.message}', 'WS');
  } else if (error is HandshakeException) {
    AppLogger.e('‚ùå [WS] HandshakeException –≤ stream: ${error.message}', 'WS');
  } else if (error is TimeoutException) {
    AppLogger.e('‚ùå [WS] TimeoutException –≤ stream', 'WS');
  }
  _updateStatus(WebSocketStatus.error);
  _scheduleReconnect();
}
```

**–£–ª—É—á—à–µ–Ω–æ –≤ _onDone:**
```dart
void _onDone() {
  AppLogger.w('‚ö†Ô∏è [WS] WebSocket connection closed by server or network', 'WS');
  _updateStatus(WebSocketStatus.disconnected);
  _close();
  if (_shouldReconnect) {
    AppLogger.i('üîÑ [WS] Scheduling reconnect...', 'WS');
    _scheduleReconnect();
  } else {
    AppLogger.i('üõë [WS] Reconnect disabled, staying disconnected', 'WS');
  }
}
```

---

### üìù –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

#### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è - –°–û–ó–î–ê–ù–û ‚úÖ

**–§–∞–π–ª—ã:**
- `flutter/mvp/WEBSOCKET_DEBUG.md` - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–ª–∞–¥–∫–µ WebSocket
- `WEBSOCKET_FIX_CHANGELOG.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª (—Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ WEBSOCKET_DEBUG.md:**
- –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
- –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ Android —á–µ—Ä–µ–∑ ADB
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –ª–æ–≥–æ–≤
- –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è
- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

#### 6. –£–ª—É—á—à–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ - –û–ë–ù–û–í–õ–ï–ù–û ‚úÖ

**–§–∞–π–ª:** `flutter/mvp/lib/config.dart`

**–î–æ–±–∞–≤–ª–µ–Ω—ã:**
- –û–ø–∏—Å–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ AppConfig
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—é
- –ü–æ—è—Å–Ω–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

---

## üîç –ü–†–û–í–ï–†–ï–ù–ù–´–ï, –ù–û –ù–ï –¢–†–ï–ë–£–Æ–©–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô

### Flutter –∫–æ–¥:
- ‚úÖ `lib/main.dart` - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
- ‚úÖ `lib/presentation/providers/websocket_provider.dart` - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ `lib/router.dart` - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- ‚úÖ `lib/presentation/screens/main/home_screen.dart` - –ù–µ—Ç –æ—à–∏–±–æ–∫
- ‚úÖ `lib/core/utils/logger.dart` - –û—Ç–ª–∏—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ `lib/domain/services/webrtc_service.dart` - WebRTC –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### Android –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- ‚úÖ `AndroidManifest.xml` - –í—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- ‚úÖ `build.gradle.kts` - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∫–∏
- ‚úÖ SDK –≤–µ—Ä—Å–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã (minSdk=21, targetSdk=latest)

### –°–µ—Ä–≤–µ—Ä:
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
- ‚úÖ WebSocket handler –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

---

## üìä –ò–¢–û–ì–ò

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫: 2
1. Origin blocking –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ network security config –Ω–∞ Android

### –î–æ–±–∞–≤–ª–µ–Ω–æ —É–ª—É—á—à–µ–Ω–∏–π: 4
1. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket
2. –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—à–∏–±–æ–∫
3. –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ—Ç–ª–∞–¥–∫–µ
4. –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ

### –§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ: 5
1. `app/ws.py`
2. `flutter/mvp/lib/data/data_sources/remote/websocket_client.dart`
3. `flutter/mvp/android/app/src/main/AndroidManifest.xml`
4. `flutter/mvp/lib/config.dart`
5. `flutter/mvp/android/app/src/main/res/xml/network_security_config.xml` (–Ω–æ–≤—ã–π)

### –§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: 2
1. `flutter/mvp/WEBSOCKET_DEBUG.md`
2. `WEBSOCKET_FIX_CHANGELOG.md`

---

## üöÄ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
cd c:\Users\pc\Desktop\servermvp
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
python main.py
```

### 2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
cd c:\Users\pc\Desktop\servermvp\flutter\mvp
flutter clean
flutter pub get
flutter build apk --release
# –∏–ª–∏
flutter run --release
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
# –í –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
flutter run --release

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
adb logcat | findstr "MVP_CLIENT"
```

### 4. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:
```
‚úÖ MVP_CLIENT [MAIN] User authenticated, connecting WebSocket...
üîå MVP_CLIENT [WS] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket: wss://pixeltoo.ru:8089
‚úÖ MVP_CLIENT [WS] WebSocket —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!
‚úÖ MVP_CLIENT [WS] Ping —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω
```

---

## üìû –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–ê –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: `/var/mvp/mvp_server.log`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω: `Test-NetConnection pixeltoo.ru -Port 8089`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
4. –°–º–æ—Ç—Ä–∏—Ç–µ `WEBSOCKET_DEBUG.md` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏: `adb logcat > full_logs.txt`

---

## ‚úÖ –ö–õ–Æ–ß–ï–í–´–ï –ú–ï–¢–†–ò–ö–ò

- **–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~30 –º–∏–Ω—É—Ç
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–æ:** ~150
- **–°—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** ~500+
- **–¢–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è:** 6+ (SocketException, TimeoutException, HandshakeException, etc.)
- **–£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:** 10x (–±–ª–∞–≥–æ–¥–∞—Ä—è –¥–µ—Ç–∞–ª—å–Ω–æ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—é)

---

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ Origin –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –¢–µ–ø–µ—Ä—å:

1. ‚úÖ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
2. ‚úÖ Android –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏
3. ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
4. ‚úÖ –í—Å–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Å –ø–æ–ª–µ–∑–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
5. ‚úÖ –ï—Å—Ç—å –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**WebSocket –¥–æ–ª–∂–µ–Ω —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—Ç—å!** üéâ
