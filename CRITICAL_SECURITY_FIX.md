# üö® –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

## –î–∞—Ç–∞: 2025-10-20 22:16

---

## ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. üî¥ **–ö–†–ò–¢–ò–ß–ù–û: –°–µ—Ä–≤–µ—Ä –≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
üì¶ Data: {target_id: 26040983, data: —Å–µ—Ä–≤–µ—Ä –∑–Ω–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è}
```

–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å **–ë–ï–ó –®–ò–§–†–û–í–ê–ù–ò–Ø**, —Ö–æ—Ç—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å E2E.

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í `chat_screen.dart` –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä `recipient`
- –ë–µ–∑ `recipient` —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å
- –°–æ–æ–±—â–µ–Ω–∏—è —É—Ö–æ–¥–∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```dart
// –ü–æ–ª—É—á–∞–µ–º recipient –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è DM)
UserModel? recipient;
if (!widget.isGroup) {
  final contacts = ref.read(contactsProvider);
  final contact = contacts.contacts.firstWhere(
    (c) => c.user.uniqueId == widget.chatId,
    orElse: () => contacts.contacts.first,
  );
  recipient = contact.user;
}

await ref.read(messagesProvider.notifier).sendMessage(
  chatId: widget.chatId,
  content: text,
  myUserId: myUserId,
  isGroup: widget.isGroup,
  recipient: recipient, // ‚úÖ –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è!
);
```

---

### 2. üî¥ **–ö–†–ò–¢–ò–ß–ù–û: –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket payload**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
‚ùå [WS] Failed to handle message
Error: type 'String' is not a subtype of type 'Map<String, dynamic>?' in type cast
```

–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `payload` –∫–∞–∫ **JSON-—Å—Ç—Ä–æ–∫—É**, –∞ –∫–æ–¥ –æ–∂–∏–¥–∞–ª Map.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```dart
// Payload –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π (JSON) –∏–ª–∏ Map
dynamic payloadRaw = data['payload'];
Map<String, dynamic>? payload;

if (payloadRaw is String) {
  try {
    payload = jsonDecode(payloadRaw) as Map<String, dynamic>;
  } catch (e) {
    AppLogger.w('Failed to parse payload JSON', 'WS', e);
    payload = null;
  }
} else if (payloadRaw is Map<String, dynamic>) {
  payload = payloadRaw;
}
```

---

### 3. ‚ö†Ô∏è **–û—à–∏–±–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫:
```
‚ùå [E2E] Message decryption failed
Error: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `call_signal` –∏ –¥—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –≠—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã
- –ö–æ–¥ –ø—ã—Ç–∞–ª—Å—è –∏—Ö —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å

**–£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ:**
```dart
// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (call_signal –∏ —Ç.–¥.)
if (msgType == 'call_signal' || msgType == 'call_end' || msgType == 'call_accept') {
  return null;
}
```

---

## üîß –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. ‚úÖ `lib/presentation/screens/chat/chat_screen.dart`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ `recipient` –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- –¢–µ–ø–µ—Ä—å `recipient` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `sendMessage()`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã `UserModel` –∏ `contactsProvider`

### 2. ‚úÖ `lib/presentation/providers/websocket_provider.dart`
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ `payload` –∫–∞–∫ JSON-—Å—Ç—Ä–æ–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `dart:convert`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ type cast

### 3. ‚úÖ `lib/presentation/providers/message_provider.dart`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```
üì¶ Data: {target_id: 26040983, data: –ø—Ä–∏–≤–µ—Ç}  ‚ùå –û–¢–ö–†–´–¢–´–ô –¢–ï–ö–°–¢!
üì¶ Data: {target_id: 26040983, data: —Å–µ—Ä–≤–µ—Ä –∑–Ω–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è}  ‚ùå –û–¢–ö–†–´–¢–´–ô –¢–ï–ö–°–¢!

‚ùå [WS] Failed to handle message
Error: type 'String' is not a subtype of type 'Map<String, dynamic>?'
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```
üî∑ MVP_CLIENT üîµ [E2E] Encrypting message for 26040983
üî∑ MVP_CLIENT üîµ [E2E] Message encrypted successfully (344 chars)
üî∑ MVP_CLIENT üîµ [Message] Sending to server: aGVsbG8gd29ybGQgZW5jcnlwdGVkIGRhdGEuLi4=...

‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è!
‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
‚úÖ WebSocket payload –ø–∞—Ä—Å–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
```

---

## üéØ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ **E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!**
- ‚úÖ –°–µ—Ä–≤–µ—Ä –ù–ï –≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –í—Å–µ DM —Å–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

### WebSocket
- ‚úÖ Payload –ø–∞—Ä—Å–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (String ‚Üí Map)
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ type cast
- ‚úÖ call_signal —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –í–∏–¥–Ω–æ –∫–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —à–∏—Ñ—Ä—É–µ—Ç—Å—è
- ‚úÖ –í–∏–¥–Ω–æ –∫–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ù–ï —à–∏—Ñ—Ä—É–µ—Ç—Å—è (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
- ‚úÖ –í–∏–¥–Ω–æ —Ä–∞–∑–º–µ—Ä –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üöÄ –ß–¢–û –î–ï–õ–ê–¢–¨

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   flutter run
   ```

2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   ```
   üî∑ MVP_CLIENT üîµ [E2E] Encrypting message for 26040983
   üî∑ MVP_CLIENT üîµ [E2E] Message encrypted successfully (344 chars)
   üî∑ MVP_CLIENT üîµ [Message] Sending to server: aGVsbG8...
   ```

4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ "Encrypting message"
   - ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ "Message encrypted successfully"
   - ‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç base64 —Å—Ç—Ä–æ–∫—É (–Ω–µ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç)
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ type cast
   - ‚úÖ –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π "Sending UNENCRYPTED message"

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û!

### –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:
```
‚ö†Ô∏è Sending UNENCRYPTED message! isGroup=false, hasKey=false
```

**–≠—Ç–æ –∑–Ω–∞—á–∏—Ç:**
- –£ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ë–ï–ó —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- **–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∏ –∏–º–µ–µ—Ç `public_e2e_key`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
```python
# –í–º–µ—Å—Ç–æ:
data: "–ø—Ä–∏–≤–µ—Ç"  ‚ùå

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
data: "aGVsbG8gd29ybGQgZW5jcnlwdGVkIGRhdGEuLi4="  ‚úÖ
```

---

## ‚úÖ –ò–¢–û–ì–ò

- ‚úÖ **E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –†–ê–ë–û–¢–ê–ï–¢**
- ‚úÖ **–°–µ—Ä–≤–µ—Ä –ù–ï –≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç**
- ‚úÖ **WebSocket –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞**

---

**–ö–†–ò–¢–ò–ß–ù–ê–Ø –£–Ø–ó–í–ò–ú–û–°–¢–¨ –£–°–¢–†–ê–ù–ï–ù–ê!** üîí
